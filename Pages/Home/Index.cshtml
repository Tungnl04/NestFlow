@page
@model NestFlow.Pages.Home.IndexModel
@{
    ViewData["Title"] = "Nestflow - Tìm phòng trọ tại Hòa Lạc";
}

<!-- Banner slider -->
<div class="nf-banner-slider">
    <div id="bannerCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5000">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <div class="nf-banner-slide" style="background-image: url('https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=1920&h=600&fit=crop&q=80');">
                    <div class="nf-banner-overlay"></div>
                    <div class="nf-banner-content">
                        <h1 class="nf-banner-title">Tìm phòng trọ lý tưởng</h1>
                        <p class="nf-banner-subtitle">Nơi lưu trú hoàn hảo tại Hòa Lạc</p>
                    </div>
                </div>
            </div>
            <div class="carousel-item">
                <div class="nf-banner-slide" style="background-image: url('https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=1920&h=600&fit=crop&q=80');">
                    <div class="nf-banner-overlay"></div>
                    <div class="nf-banner-content">
                        <h1 class="nf-banner-title">Tìm phòng trọ lý tưởng</h1>
                        <p class="nf-banner-subtitle">Nơi lưu trú hoàn hảo tại Hòa Lạc</p>
                    </div>
                </div>
            </div>
            <div class="carousel-item">
                <div class="nf-banner-slide" style="background-image: url('https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=1920&h=600&fit=crop&q=80');">
                    <div class="nf-banner-overlay"></div>
                    <div class="nf-banner-content">
                        <h1 class="nf-banner-title">Tìm phòng trọ lý tưởng</h1>
                        <p class="nf-banner-subtitle">Nơi lưu trú hoàn hảo tại Hòa Lạc</p>
                    </div>
                </div>
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#bannerCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#bannerCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
            <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
        </div>
    </div>
</div>

<!-- Thanh tìm kiếm -->
<div class="nf-search-bar-section">
    <div class="container-fluid px-4">
        <div class="nf-search-bar">
            <div class="nf-search-filter">
                <label>Khu vực</label>
                <select class="form-select">
                    <option>Chọn khu vực</option>
                    <option>Thạch Thất</option>
                    <option>Thạch Hòa</option>
                    <option>Tất cả khu vực</option>
                </select>
            </div>
            <div class="nf-search-filter">
                <label>Mức giá</label>
                <select class="form-select">
                    <option>Chọn mức giá</option>
                    <option>Dưới 2 triệu</option>
                    <option>2 - 3 triệu</option>
                    <option>3 - 5 triệu</option>
                    <option>Trên 5 triệu</option>
                </select>
            </div>
            <div class="nf-search-filter">
                <label>Loại phòng</label>
                <select class="form-select">
                    <option>Chọn loại phòng</option>
                    <option>Phòng đơn</option>
                    <option>Phòng đôi</option>
                    <option>Căn hộ mini</option>
                    <option>Nhà nguyên căn</option>
                    <option>Phòng ở ghép</option>
                </select>
            </div>
            <button class="nf-search-btn-main">
                <i class="fas fa-search"></i> Tìm kiếm
            </button>
        </div>
    </div>
</div>

<!-- Nội dung chính -->
<div class="container-fluid px-4 py-5">
    @{
        // Helper functions moved to _RoomCard or not needed
    }

    <!-- Dòng 1: Tin mới nhất -->
    <section class="mb-5">
        <h3 class="nf-section-title mb-4">Tin mới nhất</h3>
        <div class="row g-4">
            @foreach (var room in Model.NewRooms)
            {
                <div class="col-md-3">
                    <partial name="_RoomCard" model="room" />
                </div>
            }
        </div>
    </section>

    <!-- Dòng 2: Tin đăng cách 1 tháng -->
    <section class="mb-5">
        <h3 class="nf-section-title mb-4">Tin đăng cách 1 tháng</h3>
        <div class="row g-4">
            @foreach (var room in Model.OneMonthRooms)
            {
                <div class="col-md-3">
                    <partial name="_RoomCard" model="room" />
                </div>
            }
        </div>
    </section>

    <!-- Dòng 3: Tin đăng cách 3 tháng -->
    @if (Model.ThreeMonthRooms.Any())
    {
        <section class="mb-5">
            <h3 class="nf-section-title mb-4">Tin đăng cách 3 tháng</h3>
            <div class="row g-4">
                @foreach (var room in Model.ThreeMonthRooms)
                {
                    <div class="col-md-3">
                        <partial name="_RoomCard" model="room" />
                    </div>
                }
            </div>
        </section>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // 0. Update UI helper
            function setHeartState(btn, isFavorited) {
                const icon = btn.querySelector('i');
                if (isFavorited) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    btn.classList.add('saved');
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    btn.classList.remove('saved');
                }
            }

            // 1. Initial Load: Check status of all visible rooms
            async function checkAllFavorites() {
                try {
                    const res = await fetch('/api/favorites/me');
                    if (res.ok) {
                        const favorites = await res.json();
                        const favoritedIds = new Set(favorites.map(f => f.propertyId.toString()));
                        
                        document.querySelectorAll('.nf-save-btn').forEach(btn => {
                            const roomId = btn.dataset.roomId;
                            if (favoritedIds.has(roomId)) {
                                setHeartState(btn, true);
                            }
                        });
                    }
                } catch (e) { 
                    // Silent fail if not logged in or error
                }
            }

            // check only if might be logged in
            checkAllFavorites();

            // 2. Handle Click
            document.querySelectorAll('.nf-save-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Retrieve ID
                    const roomId = this.dataset.roomId;

                    try {
                        const res = await fetch(`/api/favorites/toggle/${roomId}`, { method: 'POST' });
                        
                        if (res.status === 401) {
                             // Open login modal if exists, or redirect
                             const loginModalEl = document.getElementById('loginModal');
                             if (loginModalEl) {
                                const loginModal = new bootstrap.Modal(loginModalEl);
                                loginModal.show();
                             } else {
                                 window.location.href = '/Auth/Login';
                             }
                            return;
                        }

                        if (res.ok) {
                            const data = await res.json();
                            setHeartState(this, data.isFavorited);
                            
                             // Optional: Show toast
                            if (typeof NotificationSystem !== 'undefined' && NotificationSystem.showToast) {
                                // NotificationSystem.showToast("Thông báo", data.message);
                            }
                        }
                    } catch (err) {
                        console.error("Error toggling favorite:", err);
                    }
                });
            });
        });
    </script>
}
