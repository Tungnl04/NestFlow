@page "{id:long?}"
@model NestFlow.Pages.Room.ContactModel
@{
    ViewData["Title"] = "Liên hệ chủ trọ - Nestflow";
    // Mock data
    var landlord = new { Name = "Anh Minh", Avatar = "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=200", Phone = "0359940918" };
    var room = new { Name = "Nhà nguyên căn Hòa Lạc", RoomType = "2 phòng ngủ", Price = 8000000, Image = "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400&h=250&fit=crop&q=80" };

    Func<int, string> FormatPrice = (price) => price.ToString("N0") + "đ";
}

<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- Chat Modal Style -->
            <div class="card">
                <div class="card-header border-bottom d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <img src="@landlord.Avatar" alt="@landlord.Name" class="nf-chat-avatar-img" />
                        <div>
                            <h5 class="mb-0 fw-bold">@landlord.Name</h5>
                            <p class="text-muted small mb-0">Thường trả lời trong vài phút</p>
                        </div>
                    </div>
                    <button class="btn btn-link p-0" onclick="window.history.back()">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>

                <!-- Room Info -->
                <div class="bg-blue-50 p-4 border-bottom">
                    <div class="d-flex gap-3">
                        <img src="@room.Image" alt="@room.Name" class="nf-room-thumb" />
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-1">@room.Name</h6>
                            <p class="text-muted small mb-1">Loại: @room.RoomType</p>
                            <p class="fw-bold text-primary mb-0">@FormatPrice(room.Price)/tháng</p>
                        </div>
                    </div>
                </div>

                <!-- Contact Info -->
                <div class="bg-green-50 p-4 border-bottom">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted small mb-1">Số điện thoại chủ trọ:</p>
                            <p class="fw-bold fs-5 mb-0">@landlord.Phone</p>
                        </div>
                        <a href="tel:@landlord.Phone" class="btn btn-success nf-call-btn" id="callBtn">
                            <i class="fas fa-phone"></i> Gọi ngay
                        </a>
                    </div>
                </div>

                <!-- Messages -->
                <div class="nf-chat-messages-container" id="chatMessages">
                    <div class="nf-chat-message">
                        <div class="nf-chat-avatar"></div>
                        <div class="nf-chat-bubble">
                            <p class="mb-0">Xin chào! Tôi có thể giúp gì cho bạn?</p>
                            <small class="text-muted">17:15</small>
                        </div>
                    </div>
                </div>

                <!-- Input -->
                <div class="border-top p-4">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Nhập tin nhắn..." id="chatInput">
                        <button class="btn nf-btn-primary" type="button" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <button class="btn btn-success w-100 nf-book-btn" id="bookBtn1" data-bs-toggle="modal" data-bs-target="#bookingModal">
                        <i class="fas fa-calendar-check"></i> Đặt phòng
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 100px;">
                <div class="card-body">
                    <div class="mb-3">
                        <img src="@room.Image" class="img-fluid rounded mb-3" alt="Phòng trọ" />
                    </div>
                    <h5 class="card-title mb-3">@room.Name</h5>
                    <div class="mb-3">
                        <small class="text-muted">Loại: @room.RoomType</small>
                    </div>
                    <div class="mb-3">
                        <div class="nf-room-price-large">@FormatPrice(room.Price)/tháng</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Loại phòng:</label>
                        <select class="form-select" id="roomTypeSelect">
                            <option>2 phòng ngủ - @FormatPrice(8000000)/tháng</option>
                            <option>3 phòng ngủ - @FormatPrice(9000000)/tháng</option>
                        </select>
                    </div>
                    <button class="btn nf-btn-primary w-100 nf-book-btn" id="bookBtn2" data-bs-toggle="modal" data-bs-target="#bookingModal">
                        <i class="fas fa-calendar-check"></i> Đặt phòng
                    </button>
                    <p class="text-muted small mt-2 mb-0">Bạn vẫn chưa bị trừ tiền</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Đặt phòng -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Đặt phòng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="propertyId" value="@Model.Property.PropertyId" />
                    
                    <!-- Thông tin user nếu đã login -->
                    @if (Model.IsLoggedIn && Model.CurrentUser != null)
                    {
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-check-circle me-2"></i>
                            Đặt phòng với tài khoản: <strong>@Model.CurrentUser.FullName</strong>
                        </div>
                    }
                    else
                    {
                        <!-- Form cho guest -->
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Vui lòng điền thông tin liên hệ
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="fullName" placeholder="Nguyễn Văn A" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="phone" placeholder="0912345678" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" placeholder="example@email.com" required>
                        </div>
                    }
                    
                    <div class="mb-3">
                        <label class="form-label">Ngày xem phòng <span class="text-danger">*</span></label>
                        <input type="datetime-local" 
                               class="form-control" 
                               id="bookingDate" 
                               min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")"
                               required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea class="form-control" id="notes" rows="2" placeholder="Ghi chú thêm..."></textarea>
                    </div>

                    <!-- Thông tin thanh toán -->
                    @if (Model.Property != null && Model.Property.Deposit.HasValue)
                    {
                        <div class="border-top pt-3 mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tiền đặt cọc:</span>
                                <strong class="text-primary">@Model.Property.Deposit?.ToString("N0") VNĐ</strong>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Tiền cọc sẽ được hoàn lại nếu chủ nhà từ chối
                            </small>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Chưa có thông tin tiền đặt cọc. Vui lòng liên hệ chủ nhà.
                        </div>
                    }
                    
                    <button type="submit" class="btn nf-btn-primary w-100" id="btnBookingSubmit">
                        <i class="fas fa-lock me-2"></i>Thanh toán an toàn với PayOS
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .nf-chat-avatar-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .nf-room-thumb {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        object-fit: cover;
    }

    .nf-chat-messages-container {
        height: 400px;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
    }

    .nf-chat-message {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

        .nf-chat-message.user {
            flex-direction: row-reverse;
        }

    .nf-chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4A90E2, #50C878);
        flex-shrink: 0;
    }

    .nf-chat-bubble {
        background: #f0f0f0;
        padding: 0.75rem 1rem;
        border-radius: 15px;
        max-width: 70%;
    }

    .nf-chat-message.user .nf-chat-bubble {
        background: #4A90E2;
        color: #fff;
    }

    .nf-room-price-large {
        font-size: 1.5rem;
        font-weight: 700;
        color: #4A90E2;
    }
</style>

@section Scripts {
    <script>
        // Xử lý booking form
        const bookingForm = document.getElementById('bookingForm');
        const userLoggedIn = @(Model.IsLoggedIn ? "true" : "false");
        
        console.log('Booking form initialized. IsLoggedIn:', userLoggedIn);
        
        if (bookingForm) {
            bookingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('Form submitted');
                
                const propertyId = document.getElementById('propertyId').value;
                const bookingDate = document.getElementById('bookingDate').value;
                const notes = document.getElementById('notes').value;
                
                console.log('PropertyId:', propertyId);
                console.log('BookingDate:', bookingDate);
                
                if (!bookingDate) {
                    alert('Vui lòng chọn ngày xem phòng');
                    return;
                }

                // Prepare request data
                const requestData = {
                    propertyId: parseInt(propertyId),
                    bookingDate: bookingDate,
                    notes: notes
                };

                // Nếu chưa login, thêm thông tin liên hệ
                if (!userLoggedIn) {
                    const fullName = document.getElementById('fullName')?.value;
                    const email = document.getElementById('email')?.value;
                    const phone = document.getElementById('phone')?.value;

                    console.log('Guest booking - FullName:', fullName, 'Email:', email, 'Phone:', phone);

                    if (!fullName || !email || !phone) {
                        alert('Vui lòng điền đầy đủ thông tin liên hệ');
                        return;
                    }

                    requestData.fullName = fullName;
                    requestData.email = email;
                    requestData.phone = phone;
                }
                
                console.log('Request data:', requestData);
                
                const btn = document.getElementById('btnBookingSubmit');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
                
                console.log('Calling API...');
                
                // Gọi API tạo thanh toán
                fetch('/api/Payment/create-booking-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    console.log('API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API Response data:', data);
                    
                    if (data.success && data.checkoutUrl) {
                        console.log('Redirecting to:', data.checkoutUrl);
                        // Redirect đến PayOS
                        window.location.href = data.checkoutUrl;
                    } else {
                        console.error('API returned error:', data.message);
                        alert('Có lỗi xảy ra: ' + (data.message || 'Không thể tạo link thanh toán'));
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-lock me-2"></i>Thanh toán an toàn với PayOS';
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    alert('Có lỗi xảy ra khi kết nối server: ' + error.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-lock me-2"></i>Thanh toán an toàn với PayOS';
                });
            });
        } else {
            console.error('Booking form not found!');
        }

        // Xử lý gửi tin nhắn
        document.getElementById('sendBtn').addEventListener('click', function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'nf-chat-message user';
                const now = new Date();
                const time = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                messageDiv.innerHTML = `
                    <div class="nf-chat-avatar"></div>
                    <div class="nf-chat-bubble">
                        <p class="mb-0">${message}</p>
                        <small style="color: rgba(255,255,255,0.8);">${time}</small>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                input.value = '';

                // Simulate response
                setTimeout(() => {
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'nf-chat-message';
                    const responseTime = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    responseDiv.innerHTML = `
                        <div class="nf-chat-avatar"></div>
                        <div class="nf-chat-bubble">
                            <p class="mb-0">Cảm ơn bạn đã quan tâm! Tôi sẽ trả lời bạn sớm nhất có thể.</p>
                            <small class="text-muted">${responseTime}</small>
                        </div>
                    `;
                    messagesContainer.appendChild(responseDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 1000);
            }
        });

        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('sendBtn').click();
            }
        });

        // Kiểm tra role và disable booking nếu không phải tenant
        const userRole = localStorage.getItem('userRole');
        const landlordViewMode = localStorage.getItem('landlordViewMode');

        // Chỉ disable booking nếu là admin, landlord hoặc đang ở landlord view mode
        // Tenant có thể đặt phòng bình thường
        if (userRole && (userRole === 'admin' || userRole === 'landlord' || landlordViewMode === 'true')) {
            const callBtn = document.getElementById('callBtn');
            const bookBtn1 = document.getElementById('bookBtn1');
            const bookBtn2 = document.getElementById('bookBtn2');
            const bookingModal = document.getElementById('bookingModal');

            function disableBooking(element, message) {
                if (element) {
                    element.style.pointerEvents = 'none';
                    element.style.opacity = '0.6';
                    element.style.cursor = 'not-allowed';
                    element.title = message;
                    element.onclick = function(e) {
                        e.preventDefault();
                        alert('Chỉ người thuê mới có thể đặt phòng. Vui lòng đăng nhập với tài khoản người thuê.');
                        return false;
                    };
                }
            }

            disableBooking(callBtn, 'Chỉ người thuê mới có thể gọi điện');
            disableBooking(bookBtn1, 'Chỉ người thuê mới có thể đặt phòng');
            disableBooking(bookBtn2, 'Chỉ người thuê mới có thể đặt phòng');

            // Disable modal booking
            if (bookingModal) {
                bookingModal.addEventListener('show.bs.modal', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('Chỉ người thuê mới có thể đặt phòng. Vui lòng đăng nhập với tài khoản người thuê.');
                    const modal = bootstrap.Modal.getInstance(bookingModal);
                    if (modal) {
                        modal.hide();
                    }
                    return false;
                }, { once: false });
            }
        } else {
            // Đảm bảo tenant có thể đặt phòng - remove any disabled state
            const callBtn = document.getElementById('callBtn');
            const bookBtn1 = document.getElementById('bookBtn1');
            const bookBtn2 = document.getElementById('bookBtn2');

            function enableBooking(element) {
                if (element) {
                    element.style.pointerEvents = 'auto';
                    element.style.opacity = '1';
                    element.style.cursor = 'pointer';
                    element.title = '';
                    element.onclick = null;
                }
            }

            enableBooking(callBtn);
            enableBooking(bookBtn1);
            enableBooking(bookBtn2);

            // Remove landlord-view-mode class
            document.body.classList.remove('landlord-view-mode');
        }
    </script>
}