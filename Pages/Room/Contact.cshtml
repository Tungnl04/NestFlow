@page "{id:long?}"
@model NestFlow.Pages.Room.ContactModel
@{
    ViewData["Title"] = "Liên hệ chủ trọ - Nestflow";
    var landlord = Model.Property?.Landlord;
    var property = Model.Property;
    
    // GIẢM GIÁ 500K KHI ĐẶT QUA NỀN TẢNG
    decimal platformDiscount = 500000;
    decimal originalDeposit = property?.Deposit ?? 0;
    decimal discountedDeposit = originalDeposit - platformDiscount;
    if (discountedDeposit < 0) discountedDeposit = 0;
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Thông tin chủ trọ -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        @if (!string.IsNullOrEmpty(landlord?.AvatarUrl))
                        {
                            <img src="@landlord.AvatarUrl" alt="@landlord.FullName" 
                                 class="rounded-circle me-3" 
                                 style="width: 80px; height: 80px; object-fit: cover;">
                        }
                        else
                        {
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" 
                                 style="width: 80px; height: 80px; font-size: 32px;">
                                @(landlord?.FullName?.Substring(0, 1).ToUpper() ?? "?")
                            </div>
                        }
                        <div>
                            <h4 class="mb-1">@landlord?.FullName</h4>
                            <p class="text-muted mb-0">Chủ nhà</p>
                        </div>
                    </div>

                    <!-- Thông tin phòng -->
                    <div class="border-top pt-3 mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                @if (property?.PropertyImages != null && property.PropertyImages.Any())
                                {
                                    <img src="@property.PropertyImages.First().ImageUrl" 
                                         class="img-fluid rounded" 
                                         alt="@property.Title">
                                }
                            </div>
                            <div class="col-md-8">
                                <h5 class="mb-2">@property?.Title</h5>
                                <p class="text-muted mb-2">@property?.PropertyType</p>
                                <h4 class="text-primary mb-0">@property?.Price?.ToString("N0") VNĐ/tháng</h4>
                            </div>
                        </div>
                    </div>

                    <!-- Số điện thoại liên hệ -->
                    <div class="border-top pt-3">
                        <h5 class="mb-3">
                            <i class="fas fa-phone-alt me-2 text-primary"></i>
                            Liên hệ trực tiếp
                        </h5>
                        <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                            <div>
                                <p class="mb-1 text-muted small">Số điện thoại chủ nhà:</p>
                                <h4 class="mb-0 text-primary">@landlord?.Phone</h4>
                            </div>
                            <a href="tel:@landlord?.Phone" class="btn btn-success btn-lg">
                                <i class="fas fa-phone me-2"></i>Gọi ngay
                            </a>
                        </div>
                        <p class="text-muted small mt-2 mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            Liên hệ với chủ nhà để xem phòng và thỏa thuận. Nếu đồng ý, hãy đặt cọc qua nền tảng để được giảm giá!
                        </p>
                    </div>
                </div>
            </div>

            <!-- Ưu đãi đặt qua nền tảng -->
            @if (Model.IsLoggedIn)
            {
                <div class="card shadow-sm border-primary mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-gift fa-lg"></i>
                            </div>
                            <div>
                                <h5 class="mb-0 text-primary">Ưu đãi đặt qua NestFlow</h5>
                                <p class="mb-0 text-muted small">Giảm ngay 500,000 VNĐ tiền đặt cọc</p>
                            </div>
                        </div>

                        <div class="border-top pt-3">
                            <div class="row mb-2">
                                <div class="col-6">
                                    <span class="text-muted">Tiền cọc gốc:</span>
                                </div>
                                <div class="col-6 text-end">
                                    <span class="text-decoration-line-through">@originalDeposit.ToString("N0") VNĐ</span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <span class="text-success fw-bold">Giảm giá:</span>
                                </div>
                                <div class="col-6 text-end">
                                    <span class="text-success fw-bold">-@platformDiscount.ToString("N0") VNĐ</span>
                                </div>
                            </div>
                            <div class="row border-top pt-2">
                                <div class="col-6">
                                    <span class="fw-bold">Chỉ còn:</span>
                                </div>
                                <div class="col-6 text-end">
                                    <h4 class="text-primary mb-0">@discountedDeposit.ToString("N0") VNĐ</h4>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg w-100 mt-3" 
                                data-bs-toggle="modal" 
                                data-bs-target="#bookingModal">
                            <i class="fas fa-calendar-check me-2"></i>
                            Đặt cọc ngay - Tiết kiệm 500K
                        </button>
                        <p class="text-muted small text-center mt-2 mb-0">
                            <i class="fas fa-shield-alt me-1"></i>
                            Thanh toán an toàn qua PayOS
                        </p>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm border-warning mb-4">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-lock fa-3x text-warning"></i>
                        </div>
                        <h5 class="mb-3">Đăng nhập để đặt phòng</h5>
                        <p class="text-muted mb-3">
                            Đăng nhập ngay để được giảm <strong class="text-success">500,000 VNĐ</strong> tiền đặt cọc!
                        </p>
                        <button class="btn btn-primary btn-lg w-100" onclick="showLoginModal()">
                            <i class="fas fa-sign-in-alt me-2"></i>
                            Đăng nhập ngay
                        </button>
                        <p class="text-muted small mt-2 mb-0">
                            Chưa có tài khoản? <a href="#" onclick="showRegisterModal(); return false;">Đăng ký ngay</a>
                        </p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal Đặt phòng - CHỈ HIỂN THỊ KHI ĐÃ LOGIN -->
@if (Model.IsLoggedIn)
{
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">
                        <i class="fas fa-calendar-check me-2"></i>Đặt cọc phòng
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bookingForm">
                        <input type="hidden" id="propertyId" value="@Model.Property.PropertyId" />
                        
                        <!-- Thông tin user đã login -->
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-user-check me-2"></i>
                            Đặt phòng với tài khoản: <strong>@Model.CurrentUser?.FullName</strong>
                        </div>

                        <!-- Ưu đãi -->
                        <div class="alert alert-primary mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-gift fa-2x me-3"></i>
                                <div>
                                    <strong>Ưu đãi đặc biệt!</strong>
                                    <p class="mb-0 small">Giảm ngay 500,000 VNĐ khi đặt cọc qua NestFlow</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ngày xem phòng <span class="text-danger">*</span></label>
                            <input type="datetime-local" 
                                   class="form-control" 
                                   id="bookingDate" 
                                   min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")"
                                   required>
                            <small class="text-muted">Chọn thời gian bạn muốn đến xem phòng</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="notes" rows="2" placeholder="Ghi chú thêm..."></textarea>
                        </div>

                        <!-- Thông tin thanh toán -->
                        <div class="border-top pt-3 mb-3">
                            <h6 class="mb-3">Chi tiết thanh toán</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tiền cọc gốc:</span>
                                <span class="text-decoration-line-through">@originalDeposit.ToString("N0") VNĐ</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2 text-success">
                                <span><strong>Giảm giá nền tảng:</strong></span>
                                <strong>-@platformDiscount.ToString("N0") VNĐ</strong>
                            </div>
                            <div class="d-flex justify-content-between border-top pt-2">
                                <span class="fw-bold">Tổng thanh toán:</span>
                                <h5 class="text-primary mb-0">@discountedDeposit.ToString("N0") VNĐ</h5>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Tiền cọc sẽ được hoàn lại nếu chủ nhà từ chối
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg w-100" id="btnBookingSubmit">
                            <i class="fas fa-lock me-2"></i>Thanh toán an toàn với PayOS
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .nf-chat-avatar-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .nf-room-thumb {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        object-fit: cover;
    }

    .nf-chat-messages-container {
        height: 400px;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
    }

    .nf-chat-message {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

        .nf-chat-message.user {
            flex-direction: row-reverse;
        }

    .nf-chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4A90E2, #50C878);
        flex-shrink: 0;
    }

    .nf-chat-bubble {
        background: #f0f0f0;
        padding: 0.75rem 1rem;
        border-radius: 15px;
        max-width: 70%;
    }

    .nf-chat-message.user .nf-chat-bubble {
        background: #4A90E2;
        color: #fff;
    }

    .nf-room-price-large {
        font-size: 1.5rem;
        font-weight: 700;
        color: #4A90E2;
    }
</style>

@section Scripts {
    <script>
        // Hàm mở modal đăng nhập
        function showLoginModal() {
            // Giả sử bạn có modal đăng nhập trong _AuthModals.cshtml
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }

        // Hàm mở modal đăng ký
        function showRegisterModal() {
            const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
            registerModal.show();
        }

        // Xử lý booking form - CHỈ CHO USER ĐÃ LOGIN
        const bookingForm = document.getElementById('bookingForm');
        
        if (bookingForm) {
            console.log('Booking form initialized for logged-in user');
            
            bookingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('Form submitted');
                
                const propertyId = document.getElementById('propertyId').value;
                const bookingDate = document.getElementById('bookingDate').value;
                const notes = document.getElementById('notes').value;
                
                console.log('PropertyId:', propertyId);
                console.log('BookingDate:', bookingDate);
                
                if (!bookingDate) {
                    alert('Vui lòng chọn ngày xem phòng');
                    return;
                }

                // Request data - CHỈ CẦN THÔNG TIN CƠ BẢN
                const requestData = {
                    propertyId: parseInt(propertyId),
                    bookingDate: bookingDate,
                    notes: notes
                };
                
                console.log('Request data:', requestData);
                
                const btn = document.getElementById('btnBookingSubmit');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
                
                console.log('Calling API...');
                
                // Gọi API tạo thanh toán
                fetch('/api/Payment/create-booking-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    console.log('API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API Response data:', data);
                    
                    if (data.success && data.checkoutUrl) {
                        console.log('Redirecting to:', data.checkoutUrl);
                        // Redirect đến PayOS
                        window.location.href = data.checkoutUrl;
                    } else {
                        console.error('API returned error:', data.message);
                        alert('Có lỗi xảy ra: ' + (data.message || 'Không thể tạo link thanh toán'));
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-lock me-2"></i>Thanh toán an toàn với PayOS';
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    alert('Có lỗi xảy ra khi kết nối server: ' + error.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-lock me-2"></i>Thanh toán an toàn với PayOS';
                });
            });
        }
    </script>
}