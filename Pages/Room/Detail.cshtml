@page
@model NestFlow.Pages.Room.DetailModel
@{
    ViewData["Title"] = $"{Model.Property.Title} - Nestflow";

    // Helper functions
    Func<decimal?, string> FormatPrice = (price) => (price ?? 0).ToString("N0") + "đ";
    
    // Process Images
    var images = Model.Property.PropertyImages.Select(i => i.ImageUrl).ToList();
    // Fallback if no images
    if (!images.Any())
    {
        images.Add("https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=800&fit=crop&q=80");
        images.Add("https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=800&fit=crop&q=80");
    }

    var mainImage = images.First();
}

<div class="container py-4">
    <!-- Header với tên trọ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="nf-room-detail-title mb-2">@Model.Property.Title</h1>
            <div class="d-flex align-items-center gap-3">
                <div class="nf-rating">
                    <i class="fas fa-star"></i> @(Model.Property.Reviews.Any() ? Math.Round(Model.Property.Reviews.Average(r => r.Rating ?? 0), 1) : 0)
                    <span class="text-muted">(@Model.Property.Reviews.Count đánh giá)</span>
                </div>
                <span class="text-muted">@Model.Property.Address, @Model.Property.Ward, @Model.Property.City</span>
            </div>
        </div>
        <button class="btn btn-link p-0" onclick="window.history.back()">
            <i class="fas fa-times fa-lg"></i>
        </button>
    </div>

    <!-- Hình ảnh trọ -->
    <div class="nf-room-gallery mb-4">
        <div class="row g-2">
            <div class="col-md-8">
                <img src="@mainImage" class="img-fluid rounded w-100" alt="@Model.Property.Title" id="mainImage" style="height: 500px; object-fit: cover;" />
            </div>
            <div class="col-md-4">
                <div class="row g-2">
                    @for (int i = 1; i < images.Count && i < 3; i++)
                    {
                        <div class="col-12">
                            <img src="@images[i]" class="img-fluid rounded w-100" alt="Ảnh @(i+1)" onclick="document.getElementById('mainImage').src = this.src" style="cursor: pointer; height: 245px; object-fit: cover;" />
                        </div>
                    }
                    @if (images.Count <= 1)
                    {
                         // Show placeholders if not enough images
                        <div class="col-12">
                            <img src="https://via.placeholder.com/400x240?text=No+Image" class="img-fluid rounded w-100" style="height: 245px; object-fit: cover;" />
                        </div>
                        <div class="col-12">
                            <img src="https://via.placeholder.com/400x240?text=NestFlow" class="img-fluid rounded w-100" style="height: 245px; object-fit: cover;" />
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="d-flex gap-2 mt-3">
            <button class="btn btn-outline-secondary">
                <i class="fas fa-share"></i> Chia sẻ
            </button>
            <button class="btn btn-outline-danger nf-save-btn-detail">
                <i class="far fa-heart"></i> Lưu tin
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Giá tiền và loại phòng -->
            <div class="nf-room-pricing mb-4">
                <h3 class="mb-3">Giá và thông tin chính</h3>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-muted mb-1">Mức giá</p>
                    <p class="text-2xl font-bold text-primary mb-0" id="selectedPrice">@FormatPrice(Model.Property.Price)/tháng</p>
                </div>
            </div>

            <!-- Mô tả -->
            <div class="mb-4">
                <h3 class="mb-3">Mô tả</h3>
                <p class="text-muted" style="white-space: pre-line;">@Model.Property.Description</p>
                <div class="mt-3 text-sm text-muted">
                    <p>Diện tích: @(Model.Property.Area ?? 0) m²</p>
                    <p>Loại phòng: @Model.Property.PropertyType</p>
                    <p>Ngày đăng: @Model.Property.CreatedAt?.ToString("dd/MM/yyyy")</p>
                </div>
            </div>

            <!-- Tiện nghi -->
            <div class="nf-room-features mb-4">
                <h3 class="mb-3">Tiện nghi</h3>
                <div class="row g-3">
                    @if (Model.Property.Amenities.Any())
                    {
                        foreach (var amenity in Model.Property.Amenities)
                        {
                            <div class="col-md-6">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="nf-amenity-dot"></div>
                                    <span>@amenity.Name</span>
                                </div>
                            </div>
                        }
                    } 
                    else 
                    {
                        <p class="text-muted">Chưa cập nhật tiện nghi.</p>
                    }
                </div>
            </div>

            <!-- Đánh giá -->
            <div class="nf-room-reviews mb-4">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <i class="fas fa-star text-warning fa-lg"></i>
                    <h3 class="mb-0">
                         @(Model.Property.Reviews.Any() ? Math.Round(Model.Property.Reviews.Average(r => r.Rating ?? 0), 1) : 0) · @Model.Property.Reviews.Count đánh giá
                    </h3>
                </div>
                @if (Model.Property.Reviews.Any())
                {
                    @foreach (var review in Model.Property.Reviews)
                    {
                         var userAvatar = review.User?.AvatarUrl ?? "/images/default-avatar.png";
                         var userName = review.User?.FullName ?? "Người dùng";
                        <div class="nf-review-item mb-3 pb-3 border-bottom">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <img src="@userAvatar" alt="@userName" class="nf-review-avatar" />
                                <div>
                                    <p class="fw-bold mb-0">@userName</p>
                                    <p class="text-muted small mb-0">@review.CreatedAt?.ToString("dd/MM/yyyy")</p>
                                </div>
                            </div>
                            <div class="mb-2">
                                @for (int i = 0; i < (review.Rating ?? 5); i++)
                                {
                                    <i class="fas fa-star text-warning"></i>
                                }
                            </div>
                            <p class="text-muted mb-0">@review.Comment</p>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Chưa có đánh giá nào.</p>
                }
            </div>

            <!-- Chủ trọ -->
            <div class="nf-landlord-info mb-4">
                <h3 class="mb-3">Liên hệ chủ trọ</h3>
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-start gap-4">
                            <img src="@(Model.Property.Landlord?.AvatarUrl ?? "https://ui-avatars.com/api/?name=Landlord")" alt="Landlord" class="nf-avatar-lg" />
                            <div class="flex-grow-1">
                                <h5 class="mb-1">@(Model.Property.Landlord?.FullName ?? "Chủ nhà")</h5>
                                <div class="d-flex align-items-center gap-3 mt-2">
                                    <div class="text-muted small">
                                        SDT: @(Model.Property.Landlord?.Phone ?? "Liên hệ check")
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Sidebar bên phải -->
        <div class="col-lg-4">
            <div class="nf-booking-card card sticky-top" style="top: 100px;">
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex align-items-baseline gap-2">
                            <span class="nf-room-price-large">@FormatPrice(Model.Property.Price)</span>
                            <span class="text-muted">/tháng</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                         <i class="fas fa-bolt text-warning"></i> Trạng thái: <strong>@Model.Property.Status</strong>
                    </div>

                    <a asp-page="/Room/Contact" asp-route-id="@Model.Property.PropertyId"
                       class="btn nf-btn-primary w-100 nf-contact-btn" id="contactBtn">
                        Liên hệ / Đặt phòng
                    </a>
                    
                    <p class="text-center text-muted small mt-2 mb-0">Không thanh toán ngay</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Global config
        const roomId = "@Model.Property.PropertyId";
        const btnSave = document.querySelector('.nf-save-btn-detail');

        // Check for booking errors from URL
        const urlParams = new URLSearchParams(window.location.search);
        const bookingError = urlParams.get('bookingError');
        const bookingSuccess = urlParams.get('bookingSuccess');
        const bookingCancelled = urlParams.get('bookingCancelled');

        if (bookingError === 'wallet_lock_failed') {
            alert('❌ Lỗi: Không thể khóa tiền vào ví chủ nhà.\n\nBooking của bạn đã được rollback về trạng thái Pending.\n\nVui lòng thử lại hoặc liên hệ admin.');
        } else if (bookingSuccess === 'true') {
            alert('✅ Đặt phòng thành công!\n\nChủ nhà sẽ xem xét và phản hồi sớm nhất.');
        } else if (bookingCancelled === 'true') {
            alert('❌ Thanh toán đã bị hủy.\n\nVui lòng thử lại nếu bạn muốn đặt phòng.');
        }

        // 1. Check current status
        async function checkFavoriteStatus() {
            if (!roomId || !btnSave) return;
            try {
                const res = await fetch(`/api/favorites/check/${roomId}`);
                if (res.ok) {
                    const data = await res.json();
                    updateFavoriteButton(data.isFavorited);
                }
            } catch (e) { console.error("Error checking favorite:", e); }
        }

        // 2. Update UI helper
        function updateFavoriteButton(isFavorited) {
            const icon = btnSave.querySelector('i');
            if (isFavorited) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                btnSave.classList.add('btn-danger');
                btnSave.classList.remove('btn-outline-danger');
                btnSave.innerHTML = '<i class="fas fa-heart"></i> Đã lưu';
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                btnSave.classList.remove('btn-danger');
                btnSave.classList.add('btn-outline-danger');
                btnSave.innerHTML = '<i class="far fa-heart"></i> Lưu tin';
            }
        }

        // 3. Handle Click
        btnSave?.addEventListener('click', async function() {
            try {
                const res = await fetch(`/api/favorites/toggle/${roomId}`, { method: 'POST' });
                
                if (res.status === 401) {
                    // Show Login Modal directly
                    const loginModalEl = document.getElementById('loginModal');
                    if (loginModalEl) {
                        const modal = new bootstrap.Modal(loginModalEl);
                        modal.show();
                    } else {
                        window.location.href = '/Auth/Login';
                    }
                    return;
                }
                
                if (res.ok) {
                    const data = await res.json();
                    updateFavoriteButton(data.isFavorited);
                    
                    // Optional: Show toast if available
                    if (typeof showToast !== 'undefined') {
                        showToast(data.message, 'success');
                    }
                }
            } catch (e) { console.error("Error toggling favorite:", e); }
        });

        // Initialize
        checkFavoriteStatus();
    </script>
}
